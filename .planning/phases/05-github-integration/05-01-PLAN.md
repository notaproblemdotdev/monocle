---
phase: 05-github-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/monocli/adapters/github.py
  - tests/test_github_adapter.py
autonomous: true

must_haves:
  truths:
    - "GitHubAdapter fetches PRs authored by current user via gh search prs"
    - "GitHubAdapter fetches issues assigned to current user via gh search issues"
    - "GitHubAdapter checks auth via gh auth status --active"
    - "Field mapping correctly transforms gh JSON to existing Pydantic models"
    - "Missing or unauthenticated gh CLI raises appropriate errors"
  artifacts:
    - path: "src/monocli/adapters/github.py"
      provides: "GitHubAdapter class with fetch_authored_prs, fetch_assigned_issues, check_auth"
      contains: "class GitHubAdapter(CLIAdapter)"
    - path: "tests/test_github_adapter.py"
      provides: "Comprehensive async tests for GitHubAdapter"
      contains: "class TestGitHubAdapter"
  key_links:
    - from: "src/monocli/adapters/github.py"
      to: "src/monocli/async_utils.py"
      via: "CLIAdapter inheritance"
      pattern: "class GitHubAdapter\\(CLIAdapter\\)"
    - from: "src/monocli/adapters/github.py"
      to: "src/monocli/models.py"
      via: "PullRequest and GitHubIssue model_validate"
      pattern: "PullRequest\\.model_validate|GitHubIssue\\.model_validate"
    - from: "src/monocli/adapters/github.py"
      to: "src/monocli/exceptions.py"
      via: "CLIAuthError and CLINotFoundError handling"
      pattern: "CLIAuthError|CLINotFoundError"
---

<objective>
Create the GitHubAdapter class and comprehensive tests, mirroring the established GitLabAdapter pattern.

Purpose: This is the core data-fetching layer for GitHub integration. The adapter translates `gh` CLI JSON output into validated Pydantic models (PullRequest, GitHubIssue) that the dashboard can display.
Output: `src/monocli/adapters/github.py` and `tests/test_github_adapter.py`
</objective>

<execution_context>
@/Users/pg/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pg/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-github-integration/05-RESEARCH.md

# Reference these files for patterns to mirror:
@src/monocli/adapters/gitlab.py
@src/monocli/async_utils.py
@src/monocli/models.py
@src/monocli/exceptions.py
@tests/test_gitlab_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHubAdapter class</name>
  <files>src/monocli/adapters/github.py</files>
  <action>
Create `src/monocli/adapters/github.py` mirroring the GitLabAdapter pattern exactly.

The class must:
1. Inherit from `CLIAdapter` with `super().__init__("gh")`
2. Import and use `get_logger(__name__)` from `monocli`
3. Import `CLIAuthError`, `CLINotFoundError` from `monocli.exceptions`
4. Import `PullRequest`, `GitHubIssue` from `monocli.models`

Methods to implement:

**`_map_pr(data: dict[str, Any]) -> dict[str, Any]`** (static method):
- Map `url` → `html_url` (CRITICAL: gh uses "url", model uses "html_url")
- Map `isDraft` → `draft` (gh uses camelCase, model uses snake_case)
- Map `createdAt` → `created_at` (same camelCase issue)
- Pass through: `number`, `title`, `state`, `author`
- Use `.get()` for optional fields (`isDraft` defaults to False, `createdAt` defaults to None)

**`_map_issue(data: dict[str, Any]) -> dict[str, Any]`** (static method):
- Same url/createdAt mapping as PRs
- Map `labels` from list of objects `[{"name": "bug", ...}]` to list of strings `["bug"]` — extract `.name` from each label dict
- Pass through: `number`, `title`, `state`, `author`, `assignees`

**`fetch_authored_prs(state: str = "open") -> list[PullRequest]`**:
- Use `gh search prs` (NOT `gh pr list` — search works globally without repo context)
- Args: `["search", "prs", "--author", "@me", "--state", state, "--json", "number,title,state,author,url,isDraft,createdAt"]`
- Call `self.fetch_json(args)` to get raw data
- Map each item through `_map_pr()` then `PullRequest.model_validate()`
- Log with structlog: info on start/success, warning on auth/not-found errors
- Catch and re-raise `CLIAuthError` and `CLINotFoundError` (like GitLabAdapter does)

**`fetch_assigned_issues(state: str = "open") -> list[GitHubIssue]`**:
- Use `gh search issues` (NOT `gh issue list`)
- Args: `["search", "issues", "--assignee", "@me", "--state", state, "--json", "number,title,state,author,url,labels,createdAt,assignees"]`
- Call `self.fetch_json(args)` to get raw data
- Map each item through `_map_issue()` then `GitHubIssue.model_validate()`
- Same logging and error handling pattern as fetch_authored_prs

**`check_auth() -> bool`**:
- Use `gh auth status --active` (NOT plain `gh auth status` — plain version has false negatives with multiple accounts)
- Args: `["auth", "status", "--active"]` with `check=True, timeout=5.0`
- Return True on success, False on CLIAuthError/CLINotFoundError/TimeoutError
- Log debug on check start, debug on success, warning on failure

The entire file should be ~100 lines. Keep it tight — the CLIAdapter base class handles all subprocess complexity.
  </action>
  <verify>
Run: `uv run ruff check src/monocli/adapters/github.py && uv run ruff format --check src/monocli/adapters/github.py`
Verify: No lint or format errors.
Run: `uv run python -c "from monocli.adapters.github import GitHubAdapter; a = GitHubAdapter(); print(f'cli_name={a.cli_name}')"` 
Verify: Prints `cli_name=gh`
  </verify>
  <done>
GitHubAdapter class exists at src/monocli/adapters/github.py with fetch_authored_prs, fetch_assigned_issues, check_auth methods. Imports cleanly without errors. Passes ruff lint and format checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive tests for GitHubAdapter</name>
  <files>tests/test_github_adapter.py</files>
  <action>
Create `tests/test_github_adapter.py` mirroring `tests/test_gitlab_adapter.py` structure exactly.

Use the SAME test patterns: `patch("shutil.which")`, `patch("asyncio.create_subprocess_exec", new_callable=AsyncMock)`, mock proc with `returncode` and `communicate`.

**Test fixtures** (module-level constants, use EXACT data from research):

`SAMPLE_PR_JSON`:
```python
[{
    "author": {"id": "MDQ6VXNlcjQyOTQ0ODA=", "is_bot": False, "login": "testuser", "type": "User", "url": "https://github.com/testuser"},
    "createdAt": "2026-01-24T20:30:52Z",
    "isDraft": False,
    "number": 42,
    "state": "open",
    "title": "Add new feature",
    "url": "https://github.com/org/repo/pull/42"
}]
```

`SAMPLE_ISSUE_JSON`:
```python
[{
    "assignees": [{"id": "MDQ6VXNlcjQyOTQ0ODA=", "is_bot": False, "login": "testuser", "type": "User", "url": "https://github.com/testuser"}],
    "author": {"id": "MDQ6VXNlcjMwNTAzNjk1", "is_bot": False, "login": "otheruser", "type": "User", "url": "https://github.com/otheruser"},
    "createdAt": "2026-01-20T10:00:00Z",
    "labels": [{"color": "d73a4a", "description": "Something isn't working", "id": "MDU6TGFiZWwxNTkzNDg0NjIw", "name": "bug"}, {"color": "0dd8ac", "description": "New feature request", "id": "MDU6TGFiZWwxNjk4MDc2MTcz", "name": "enhancement"}],
    "number": 99,
    "state": "open",
    "title": "Fix login flow",
    "url": "https://github.com/org/repo/issues/99"
}]
```

**Test classes:**

`TestGitHubAdapter`:
- `test_adapter_init`: Verify `cli_name == "gh"`, `_available is None`
- `test_is_available_installed`: mock which → True
- `test_is_available_not_installed`: mock which → None

`TestFetchAuthoredPRs`:
- `test_fetch_authored_prs_success`: Mock returns SAMPLE_PR_JSON. Assert: len==1, number==42, title=="Add new feature", state=="open", author["login"]=="testuser", `str(html_url)` == "https://github.com/org/repo/pull/42", draft==False
- `test_fetch_authored_prs_empty`: Mock returns `[]`. Assert: result == []
- `test_fetch_authored_prs_not_installed`: mock which → None. Assert: raises CLINotFoundError with cli_name=="gh"
- `test_fetch_authored_prs_auth_failure`: Mock returncode=1, stderr=b"not logged in". Assert: raises CLIAuthError

`TestFetchAssignedIssues`:
- `test_fetch_assigned_issues_success`: Mock returns SAMPLE_ISSUE_JSON. Assert: len==1, number==99, title=="Fix login flow", state=="open", labels==["bug", "enhancement"] (strings NOT dicts!), `str(html_url)` == "https://github.com/org/repo/issues/99"
- `test_fetch_assigned_issues_empty`: Mock returns `[]`. Assert: result == []
- `test_fetch_assigned_issues_not_installed`: raises CLINotFoundError
- `test_fetch_assigned_issues_auth_failure`: raises CLIAuthError

`TestCheckAuth`:
- `test_check_auth_success`: Mock returncode=0. Assert: returns True
- `test_check_auth_failure`: Mock returncode=1, stderr=b"not logged in". Assert: returns False
- `test_check_auth_not_installed`: mock which → None. Assert: returns False

All async tests use `@pytest.mark.asyncio` decorator. Import from `monocli.adapters.github import GitHubAdapter`.
  </action>
  <verify>
Run: `uv run pytest tests/test_github_adapter.py -v`
Verify: All tests pass (expect ~14 tests).
Run: `uv run ruff check tests/test_github_adapter.py && uv run ruff format --check tests/test_github_adapter.py`
Verify: No lint or format errors.
  </verify>
  <done>
All GitHubAdapter tests pass. Tests cover: init, availability, PR fetching (success/empty/not-installed/auth-failure), issue fetching (success/empty/not-installed/auth-failure), auth checking (success/failure/not-installed). Field mapping correctness verified (url→html_url, isDraft→draft, createdAt→created_at, label objects→label strings).
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_github_adapter.py -v` — all tests green
2. `uv run ruff check src/monocli/adapters/github.py tests/test_github_adapter.py` — no lint errors
3. `uv run ruff format --check src/monocli/adapters/github.py tests/test_github_adapter.py` — properly formatted
4. `uv run pytest` — full test suite still passes (no regressions)
</verification>

<success_criteria>
- GitHubAdapter class inherits CLIAdapter and follows exact same pattern as GitLabAdapter
- Field mapping correctly transforms gh JSON → PullRequest/GitHubIssue models
- Uses `gh search prs` and `gh search issues` (NOT `gh pr list`/`gh issue list`)
- Uses `gh auth status --active` (NOT plain `gh auth status`)
- All ~14 tests pass covering success, empty, not-installed, and auth-failure cases
- Full existing test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-github-integration/05-01-SUMMARY.md`
</output>
